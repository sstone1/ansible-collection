..
.. SPDX-License-Identifier: Apache-2.0
..

Building a network
==================

This tutorial will demonstrate how to use the IBM Blockchain Platform collection for Ansible to automate the process of building a new Hyperledger Fabric network.

In this tutorial, you will use the IBM Blockchain Platform collection for Ansible to build a Hyperledger Fabric network with two organizations. One organization "Ordering Org" will be the ordering organization, and that organization will run the ordering service. The other organization "Org1" will be an endorsing organization, and that organization will run a peer. You will also create a channel, and join the endorsing organizations peer into that channel.

For this tutorial, you can use the IBM Blockchain Platform on IBM Cloud, or the IBM Blockchain Platform software running in a Red Hat OpenShift or Kubernetes cluster.

Before you start
----------------

Ensure that you have installed all of the pre-requisite software described in `Installation <../installation.html>`_.

You must have access to an existing IBM Blockchain Plaform instance, either on IBM Cloud, or using the IBM Blockchain Platform software running in a Red Hat OpenShift or Kubernetes cluster.

If you wish, you can deploy the components for each organization into a separate IBM Blockchain Platform instance. If you choose to do this, then there are additional steps that you must follow which will be described below.

Cloning the repository
----------------------

The playbooks for this tutorial are stored in a GitHub repository. You must clone this GitHub repository in order to run the playbooks locally:

    .. highlight:: none

    ::

        git clone https://github.com/IBM-Blockchain/ansible-collection.git

After cloning the GitHub repository, you must change into the tutorials directory:

    .. highlight:: none

    ::

        cd ansible-collection/tutorials

Editing the variable files
--------------------------

Variable files are used to store variables that are used across multiple Ansible playbooks. Each organization has their own variable file, and you must edit these files to specify the connection details for the IBM Blockchain Platform instance for that organization.

Edit the variable files `ordering-org-vars.yml` (for Ordering Org) and `org1-vars.yml` (for Org1). The values you set depend on whether the organization is using the IBM Blockchain Platform on IBM Cloud, or the IBM Blockchain Platform software:

* If the organization is using IBM Blockchain Platform on IBM Cloud:

  1. Create service credentials for the IBM Blockchain Platform service instance, if they have not been created already.
  2. Set ``api_endpoint`` to the value of ``api_endpoint`` specified in the service credentials.
  3. Set ``api_authtype`` to ``ibmcloud``.
  4. Set ``api_key`` to the value of ``api_key`` specified in the service credentials.
  5. Note that you do not need to specify a value for ``api_secret``.

* If the organization is using IBM Blockchain Platform software:

  1. Determine the URL of your IBM Blockchain Platform console.
  2. Determine the API key and secret you use to access your IBM Blockchain Platform console. You can also use a username and password instead of an API key and secret.
  3. Set ``api_endpoint`` to the URL of your IBM Blockchain Platform console.
  4. Set ``api_authtype`` to ``basic``.
  5. Set ``api_key`` to your API key or username.
  6. Set ``api_secret`` to your API secret or password.

When the Ansible playbooks are run, the variable files are passed in to Ansible using the ``--extra-vars`` option, for example ``--extra-vars "@ordering-org-vars.yml"``.

Finally, all of these files contain a ``wait_timeout`` variable, with the default set to ``600`` (seconds). This is the amount of time in seconds to wait for certificate authorities, peers, and ordering services to start. Depending on your environment, you may need to increase this timeout, for example if it takes a long time to provision the persistent volumes for each component.

Building the network
--------------------

There are multiple Ansible playbooks used in this tutorial. Each Ansible playbook performs a part of the set of tasks required to build the network. Each of the Ansible playbooks is run as either the ordering organization "Ordering Org", or the endorsing organization "Org1".

The contents of these playbooks are explored at the end of this tutorial. For now, a script `build_network.sh <https://github.com/IBM-Blockchain/ansible-collection/blob/master/tutorial/build_network.sh>`_ has been provided which runs these Ansible playbooks in order for you.

Note that if each organization has their own IBM Blockchain Platform instance, you must run a different command. This is required as organization and ordering service information must be exported and then imported into the other IBM Blockchain Platform instance.

If you have installed the collection using Ansible Galaxy, or from source, then run the script as follows:

* Both organizations use the same IBM Blockchain Platform instance:

    ::

        ./build_network.sh build

* Each organization has their own IBM Blockchain Platform instance:

    ::

        ./build_network -i build

If you have installed the collection by building a Docker image, then run the script as follows:

* Both organizations use the same IBM Blockchain Platform instance:

    ::

        docker run --rm -v "$PWD:/tutorials" mydockerorg/ansible ansible-playbook /tutorials/build_network.sh build

* Each organization has their own IBM Blockchain Platform instance:

    ::

        docker run --rm -v "$PWD:/tutorials" mydockerorg/ansible ansible-playbook /tutorials/build_network.sh -i build

After the script has finished, you should examine the output of the script to check that no errors have occurred whilst running the Ansible playbooks. After each Ansible playbook runs, Ansible outputs a ``PLAY RECAP`` section that details how many tasks have been executed, and how many of those tasks have failed.

Exploring the network
---------------------

The Ansible playbooks that you just ran created the following components:

- An ordering organization named `Ordering Org`, with a certificate authority named `Ordering Org CA`, and an ordering service named `Ordering Service`.
- An endorsing organization named `Org1`, with a certificate authority named `Org1 CA`, and a peer named `Org1 Peer`.
- A single channel called `mychannel`, with the endorsing organization `Org1` as the only member, and the peer `Org1 Peer` as the only anchor peer.

The Ansible playbooks also register and enroll an identity - a digital certificate and private key pair - that acts as the administrator for each organization. These identities are created on disk, as JSON files in the same directory as the playbooks, and you must store these identities somewhere.

The identities created are:

- `Ordering Org CA Admin.json`

  This is the identity of the administrator for the certificate authority `Ordering Org CA`. You can use this identity to register new users, and revoke existing users.

- `Ordering Org Admin.json`

  This is the identity of the administrator for the ordering organization `Ordering Org`, and the ordering service `Ordering Service`. You can use this identity to manage the organization and the ordering service.

- `Org1 CA Admin.json`

  This is the identity of the administrator for the certificate authority `Org1 CA`. You can use this identity to register new users, and revoke existing users.

- `Org1 Admin.json`

  This is the identity of the administrator for the endorsing organization `Org1`, and the peer `Org1 Peer`. You can use this identity to manage the organization and the peer.

If you log in to the IBM Blockchain Platform console for each organization using a web browser, you should find that these components are now displayed in the list of nodes.

You can also import the JSON files containing the identities listed above into the IBM Blockchain Platform console wallet. Once all of the identities have been imported, you can associate each component with the appropriate identity. This will allow you to manage and view those components using the IBM Blockchain Platform console.

Exploring the playbooks
-----------------------

TBD

Destroying the network
----------------------

If you wish to destroy the network in order to remove all of the components created by this tutorial, then you can run additional Ansible playbooks to do this for you. You can use the `build_network.sh <https://github.com/IBM-Blockchain/ansible-collection/blob/master/tutorial/build_network.sh>`_ script again to run these Ansible playbooks.

Note that if each organization has their own IBM Blockchain Platform instance, you must run a different command.

If you have installed the collection using Ansible Galaxy, or from source, then run the script as follows:

* Both organizations use the same IBM Blockchain Platform instance:

    ::

        ./build_network.sh destroy

* Each organization has their own IBM Blockchain Platform instance:

    ::

        ./build_network -i destroy

If you have installed the collection by building a Docker image, then run the script as follows:

* Both organizations use the same IBM Blockchain Platform instance:

    ::

        docker run --rm -v "$PWD:/tutorials" mydockerorg/ansible ansible-playbook /tutorials/build_network.sh destroy

* Each organization has their own IBM Blockchain Platform instance:

    ::

        docker run --rm -v "$PWD:/tutorials" mydockerorg/ansible ansible-playbook /tutorials/build_network.sh -i destroy

After the script has finished, you should examine the output of the script to check that no errors have occurred whilst running the Ansible playbooks. After each Ansible playbook runs, Ansible outputs a ``PLAY RECAP`` section that details how many tasks have been executed, and how many of those tasks have failed.